<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Тестирование API Shiptor 1.2 (js)</title>
    <style>
        label {
            display: inline-block;
            min-width: 250px;
        }

        input {
            min-width: 150px;
        }

        select {
            min-width: 156px;
        }
    </style>
    <script>
        function Ajax() {
            this.XHR = function() {
                if (XMLHttpRequest) {
                    return new XMLHttpRequest();
                } else {
                    throw new Error('XHR не поддерживается');
                }
            };
            this.request = function(_data, _options) {
                const $R = this.XHR();
                let data = _data || {},
                    options = {
                        method: 'POST',
                        headers: [
                            [
                                'Content-Type',
                                'application/json; charset=utf-8',
                            ],
                            [
                                'x-authorization-token',
                                '5a9a56c1d6bceaa9e6c2cde5fca94e8a996b6469',
                            ],
                        ],
                        url: null,
                        async: true,
                        success: function() {
                        },
                        error: function() {
                        },
                    };

                let encodedData = JSON.stringify(data);

                if (_options) {
                    for (let i in _options) {
                        options[i] = _options[i];
                    }
                }

                if (options.url === null) {
                    throw new Error('Не залан url назначения');
                }

                $R.open(options.method, options.url, options.async);
                $R.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        if (this.status === 200) {
                            if (this.responseText === '') throw new Error('Ответ пустой');
                            options.success(this.responseText);
                        } else {
                            options.error(this.responseText);
                            switch (this.status) {
                                case 404:
                                    throw new Error('Страница не найдена');
                                case 0:
                                    throw new Error('Нет соединения с сервером');
                                default:
                                    throw new Error(`Неизвестная ошибка (${$R.status}})`);
                            }
                        }
                    }
                };
                for (let i = 0; i < options.headers.length; i++) {
                    let $i = options.headers[i];
                    $R.setRequestHeader($i[0], $i[1]);
                }
                $R.send(encodedData);
            };
        }

        function createSettlementsDropdawn(response) {
            const dropdawn = window.document.querySelector('#settlements_list'),
                settlements = response.result.settlements;

            if (settlements.length > 0) {
                let fragment = window.document.createDocumentFragment(),
                    option = window.document.createElement('OPTION');

                option.innerHTML = 'Выберете город';
                option.value = 0;
                fragment.appendChild(option);

                for (let i = 0; i < settlements.length; i++) {
                    let $i = settlements[i],
                        option = window.document.createElement('OPTION');
                    option.innerHTML = $i.name;
                    option.value = $i.kladr_id;
                    fragment.appendChild(option);
                }
                dropdawn.appendChild(fragment);
            } else {
                let option = window.document.createElement('OPTION');
                option.innerHTML = 'Ничего не найдено';
                option.value = 0;
                dropdawn.appendChild(option);
            }
        }

        function createSettlementsDropdawnFromSearch(response) {
            const dropdawn = window.document.querySelector('#settlements_list'),
                settlements = response.result;

            dropdawn.innerHTML = '';
            if (settlements.length > 0) {
                let fragment = window.document.createDocumentFragment(),
                    option = window.document.createElement('OPTION');

                option.innerHTML = 'Выберете город';
                option.value = 0;
                fragment.appendChild(option);

                for (let i = 0; i < settlements.length; i++) {
                    let $i = settlements[i],
                        option = window.document.createElement('OPTION');
                    option.innerHTML = $i.short_readable;
                    option.value = $i.kladr_id;
                    fragment.appendChild(option);
                }
                dropdawn.appendChild(fragment);
            } else {
                let option = window.document.createElement('OPTION');
                option.innerHTML = 'Ничего не найдено';
                option.value = 0;
                dropdawn.appendChild(option);
            }
        }

        function createShippingDropdawn(response) {
            const dropdawn = window.document.querySelector('#shipping_list'),
                shippings = response.result.methods;

            dropdawn.innerHTML = '';
            if (shippings.length > 0) {
                let fragment = window.document.createDocumentFragment(),
                    option = window.document.createElement('OPTION');

                option.innerHTML = 'Выберете доставку';
                option.value = 0;
                fragment.appendChild(option);

                for (let i = 0; i < shippings.length; i++) {
                    let $i = shippings[i],
                        option = window.document.createElement('OPTION');
                    option.innerHTML = `${$i.cost.total.readable}, ${$i.days}, ${$i.method.name}`;
                    option.value = $i.method.id;
                    fragment.appendChild(option);
                }
                dropdawn.appendChild(fragment);
            } else {
                let option = window.document.createElement('OPTION');
                option.innerHTML = 'Ничего не найдено';
                option.value = 0;
                dropdawn.appendChild(option);
            }
        }
    </script>
</head>
<body>
    <h1>Тестирование API Shiptor 1.2</h1>
    <a href="../index.html">На главную</a>
    <br>
    <br>
    <div id="api_output"></div>


    <section id="settlements">
        <br>
        <label for="settlements_search_input">Поиск города по названию</label>
        <input type="text" id="settlements_search_input">
        <button id="settlements_search_button">Поиск</button>
        <br>
        <label for="settlements_list">Выбрать город</label>
        <select id="settlements_list"></select>
    </section>

    <section id="shipping" style="display: none">
        <br>
        <label for="shipping_list">Выбрать доставку</label>
        <select id="shipping_list"></select>
    </section>

    <script>
        const initDefaultSettlements = function() {
            let data = {
                'id': 'JsonRpcClient.js',
                'jsonrpc': '2.0',
                'method': 'getSettlements',
                'params': {
                    'per_page': 10,
                    'page': 1,
                    'types': [
                        'Город',
                    ],
                    'level': 2,
                    'parent': '36000000000',
                    'country_code': 'RU',
                },
            };
            let $ajax = new Ajax();
            $ajax.request(data, {
                url: 'https://api.shiptor.ru/public/v1',
                success: function(response) {
                    const responseObject = JSON.parse(response);
                    console.log(responseObject);
                    createSettlementsDropdawn(responseObject);
                },
            });
        };

        const settlementsSearchButton = window.document.querySelector('#settlements_search_button');
        settlementsSearchButton.onclick = function() {
            const settlementsSearchInput = window.document.querySelector('#settlements_search_input');

            if (settlementsSearchInput.value === '') {
                return;
            }

            let data = {
                'id': 'JsonRpcClient.js',
                'jsonrpc': '2.0',
                'method': 'suggestSettlement',
                'params': {
                    'query': settlementsSearchInput.value,
                    //"parent": "36000000000",
                    'country_code': 'RU',
                },
            };

            let $ajax = new Ajax();
            $ajax.request(data, {
                url: 'https://api.shiptor.ru/public/v1',
                success: function(response) {
                    const responseObject = JSON.parse(response);
                    console.log(responseObject);
                    createSettlementsDropdawnFromSearch(responseObject);
                },
            });
        };

        const settlementsList = window.document.querySelector('#settlements_list');
        settlementsList.onchange = function() {
            if (this.value === 0) {
                return;
            }

            const section = window.document.querySelector('#shipping');
            section.style.display = 'block';

            let data = {
                'id': 'JsonRpcClient.js',
                'jsonrpc': '2.0',
                'method': 'calculateShipping',
                'params': {
                    'length': 20,
                    'width': 10,
                    'height': 20,
                    'weight': 1.5,
                    'cod': 10,
                    'declared_cost': 10,
                    'kladr_id': this.value,
                    // "courier": "dpd"
                },
            };

            let $ajax = new Ajax();
            $ajax.request(data, {
                url: 'https://api.shiptor.ru/public/v1',
                success: function(response) {
                    const responseObject = JSON.parse(response);
                    console.log(responseObject);
                    createShippingDropdawn(responseObject);
                },
            });
        };


        initDefaultSettlements();
    </script>
</body>
</html>